<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASION - Reservas de Salas</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/wasion.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    
    <div class="container">
        <header>
            <h1>WASION — Reservas de Salas</h1>
            <div class="logo">WASION</div>
        </header>

        <div class="user-info" style="background:#f8f9fa;padding:10px;border-radius:5px;margin-bottom:20px;">
            <span>Usuario: <strong>{{ current_user.username }}</strong></span>
            {% if current_user.is_superadmin() %}
                <span style="color:#dc3545;margin-left:10px;">(Super Admin)</span>
            {% elif current_user.is_admin() %}
                <span style="color:#007bff;margin-left:10px;">(Administrador)</span>
            {% else %}
                <span style="color:#28a745;margin-left:10px;">(Usuario)</span>
            {% endif %}
        </div>

        <div class="controls" style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
            <div class="date-selector">
                <label for="date">Fecha:</label>
                <input type="date" id="date" value="{{ selected_date }}" onchange="changeDate()">
            </div>

            <div class="plant-selector">
                <label for="plant">Planta:</label>
                <select id="plant" onchange="changePlant()">
                    {% for p in plants %}
                        <option value="{{ p.id }}" {% if selected_plant and p.id == selected_plant %}selected{% endif %}>
                            {{ p.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-left:auto;">
                <a href="{{ url_for('add_meeting', plant=selected_plant) }}" class="btn btn-primary">Agregar Reunión</a>
                {% if current_user.is_admin() or current_user.is_superadmin() %}
                    <a href="{{ url_for('rooms', plant=selected_plant) }}" class="btn btn-secondary">Gestionar Salas</a>
                {% endif %}
                {% if current_user.is_superadmin() %}
                    <a href="{{ url_for('plants') }}" class="btn btn-terciario">Gestionar Plantas</a>
                    <a href="{{ url_for('users') }}" class="btn btn-terciario">Gestionar Usuarios</a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-danger">Cerrar Sesión</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <p class="subtitle">Seleccione el horario para ver la reserva</p>

        <table class="meeting-table">
            <thead>
                <tr>
                    <th>HORA</th>
                    <th>SALA</th>
                    <th>Líder</th>
                    <th>Email</th>
                    <th>Asunto</th>
                    <th>Observaciones</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% set time_slots = [
                    '8:00-8:30', '8:30-9:00', '9:00-9:30', '9:30-10:00',
                    '10:00-10:30', '10:30-11:00', '11:00-11:30', '11:30-12:00',
                    '12:00-12:30', '12:30-13:00', '13:00-13:30', '13:30-14:00',
                    '14:00-14:30', '14:30-15:00', '15:00-15:30', '15:30-16:00',
                    '16:00-16:30', '16:30-17:00', '17:00-17:30', '17:30-18:00'
                ] %}
                
                {% for slot in time_slots %}
                    {% set meeting = meetings|selectattr('time_slot', 'equalto', slot)|first %}
                    <tr>
                        <td class="time-cell">{{ slot }}</td>
                        {% if meeting %}
                            <td>{{ meeting.room.name if meeting.room else 'N/A' }}{% if meeting.room and meeting.room.plant %} — {{ meeting.room.plant.name }}{% endif %}</td>
                            <td>{{ meeting.leader }}</td>
                            <td>{{ meeting.leader_email }}</td>
                            <td>{{ meeting.subject }}</td>
                            <td>{{ meeting.remarks or '' }}</td>
                            <td class="actions-cell">
                                {% if current_user.is_superadmin() %}
                                    <a href="{{ url_for('edit_meeting', id=meeting.id) }}" class="btn btn-edit">Editar</a>
                                    <form method="POST" action="{{ url_for('delete_meeting', id=meeting.id) }}" style="display:inline;" onsubmit="return confirm('¿Eliminar esta reunión?');">
                                        <button type="submit" class="btn btn-delete">Eliminar</button>
                                    </form>
                                {% else %}
                                    <span style="color:#999;">Sin permisos</span>
                                {% endif %}
                            </td>
                        {% else %}
                            <td colspan="6"></td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function changeDate() {
            const date = document.getElementById('date').value;
            const plant = document.getElementById('plant').value;
            const qs = new URLSearchParams();
            if (date) qs.set('date', date);
            if (plant) qs.set('plant', plant);
            window.location.href = '/?' + qs.toString();
        }

        function changePlant() {
            changeDate(); // reusa la misma lógica para preservar la fecha
        }
    </script>
</body>
</html>
